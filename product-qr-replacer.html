<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äºŒç»´ç æ‰¹é‡æ›¿æ¢å·¥å…· - æœ€ç»ˆå¹³è¡¡ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --bg: #f5f7fa; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header-box { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .config-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; background: #eee; margin-right: 5px; }

        /* ä¸Šä¼ åŠæ‰¹é‡æ“ä½œåŒº */
        .action-bar { display: flex; gap: 15px; margin-bottom: 30px; }
        .upload-area { 
            flex: 2; border: 2px dashed var(--primary); background: #f8fbff; 
            padding: 20px; text-align: center; cursor: pointer; border-radius: 8px;
        }
        .btn-batch { 
            flex: 1; background: #6c757d; color: white; border: none; 
            border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;
            display: none; /* æœ‰å›¾ç‰‡æ—¶æ‰æ˜¾ç¤º */
            transition: 0.3s;
        }
        .btn-batch.visible { display: block; background: #000; }
        .btn-batch:hover { opacity: 0.8; }

        /* åˆ—è¡¨é¡¹å¸ƒå±€ï¼šå¹³åˆ† 1:1 */
        .preview-item { 
            display: flex; background: #fff; border: 1px solid #e8e8e8; 
            border-radius: 12px; margin-bottom: 30px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }

        .img-container { flex: 1; background: #fafafa; border-right: 1px solid #eee; padding: 15px; display: flex; align-items: center; justify-content: center; }
        .img-container img { width: 100%; max-height: 500px; object-fit: contain; }

        .info-container { flex: 1; padding: 30px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        
        .url-box { background: #f9f9f9; border-radius: 8px; padding: 15px; border-left: 5px solid #ddd; margin-bottom: 15px; }
        .url-title { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 6px; }
        .url-content { font-family: monospace; font-size: 14px; word-break: break-all; color: var(--primary); }
        
        .btn-single-download { 
            background: var(--success); color: white; border: none; padding: 10px 20px; 
            border-radius: 6px; cursor: pointer; font-size: 14px; align-self: flex-start;
            transition: 0.2s;
        }
        .btn-single-download:hover { background: #218838; }
        
        .template-tag { font-size: 11px; color: white; padding: 2px 8px; border-radius: 4px; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="container">
    <div class="header-box">
        <div>
            <h2>å•†å“äºŒç»´ç æ›¿æ¢å™¨</h2>
            <p style="color: #999; font-size: 12px; margin: 4px 0 0 0;">æŠŠå•†å“å¡ç‰‡å†…çš„äºŒç»´ç ï¼Œæ›¿æ¢ä¸ºå¤–æ¨ç‰ˆæœ¬</p>
        </div>
        <div>
            <span class="config-badge">Search: 827,191 | 182px</span>
            <span class="config-badge">Product: 760,140 | 216px</span>
        </div>
    </div>
    
    <div class="action-bar">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <strong>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong> (æ”¯æŒæ‰¹é‡)
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        </div>
        <button id="batchDownloadBtn" class="btn-batch" onclick="downloadAll()">ä¸€é”®ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
    </div>

    <div id="resultArea"></div>
</div>

<script>
    const TEMPLATES = {
        SEARCH: { x: 827, y: 191, size: 182, label: 'Search List æ¨¡æ¿', color: '#ffc107' },
        PRODUCT: { x: 760, y: 140, size: 216, label: 'Products æ¨¡æ¿', color: '#007bff' }
    };

    // å­˜å‚¨æ‰€æœ‰å·²å¤„ç†çš„å›¾ç‰‡æ•°æ®ç”¨äºæ‰¹é‡ä¸‹è½½
    let processedImages = [];

    function getTodayStamp() {
        const d = new Date();
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `p${yy}${mm}${dd}`;
    }

    function getNewData(originalUrl) {
        const todayStamp = getTodayStamp();
        const targetCid = "53qvofdc"; 
        if (originalUrl.includes('search_list')) {
            return { url: originalUrl.replace(/hmpl=p\d+/, `hmpl=${todayStamp}`), config: TEMPLATES.SEARCH };
        } else if (originalUrl.includes('products')) {
            const baseUrl = originalUrl.split('?')[0];
            return { url: `${baseUrl}?cid=${targetCid}&hmsr=wechat&hmpl=${todayStamp}`, config: TEMPLATES.PRODUCT };
        }
        return { url: originalUrl, config: null };
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            document.getElementById('batchDownloadBtn').classList.add('visible');
        }
        for (const file of files) {
            await processImage(file);
        }
    });

    async function processImage(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    const result = getNewData(code.data);
                    if (result.config) {
                        const qrCanvas = document.createElement('canvas');
                        await QRCode.toCanvas(qrCanvas, result.url, { margin: 0, width: result.config.size, errorCorrectionLevel: 'H' });
                        ctx.drawImage(qrCanvas, result.config.x, result.config.y, result.config.size, result.config.size);
                        
                        const finalDataUrl = canvas.toDataURL('image/png');
                        const finalFileName = `final_${file.name.split('.')[0]}.png`;
                        
                        processedImages.push({ url: finalDataUrl, name: finalFileName });
                        renderRow(finalDataUrl, file.name, code.data, result.url, result.config, finalFileName);
                    }
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderRow(dataUrl, fileName, oldUrl, newUrl, config, finalFileName) {
        const row = document.createElement('div');
        row.className = 'preview-item';
        row.innerHTML = `
            <div class="img-container">
                <img src="${dataUrl}">
            </div>
            <div class="info-container">
                <div style="margin-bottom:20px">
                    <div style="font-weight:bold; font-size:16px; margin-bottom:8px">
                        ğŸ“„ ${fileName} 
                        <span class="template-tag" style="background:${config.color}">${config.label}</span>
                    </div>
                    <div class="url-box">
                        <div class="url-title">åŸå§‹é“¾æ¥:</div>
                        <div class="url-content">${oldUrl}</div>
                    </div>
                    <div class="url-box" style="border-left-color: var(--success)">
                        <div class="url-title">æ›´æ–°åé“¾æ¥:</div>
                        <div class="url-content">${newUrl}</div>
                    </div>
                </div>
                <button class="btn-single-download" onclick="downloadImage('${dataUrl}', '${finalFileName}')">
                    ä¿å­˜å•å¼ å›¾ç‰‡
                </button>
            </div>
        `;
        document.getElementById('resultArea').prepend(row);
    }

    window.downloadImage = (dataUrl, name) => {
        const link = document.createElement('a');
        link.download = name;
        link.href = dataUrl;
        link.click();
    };

    window.downloadAll = () => {
        if (processedImages.length === 0) return;
        processedImages.forEach((item, index) => {
            // ä½¿ç”¨ setTimeout é”™å¼€ä¸‹è½½è¯·æ±‚ï¼Œé˜²æ­¢æµè§ˆå™¨æ‹¦æˆª
            setTimeout(() => {
                downloadImage(item.url, item.name);
            }, index * 200); 
        });
    };
</script>

</body>
</html>